<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> 
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <title>Ù†Ø¸Ø§Ù… Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> 
    <script src="https://unpkg.com/html5-qrcode"></script> 

    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f; --archive: #8e44ad; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; direction: rtl; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--secondary); }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        button { border: none; padding: 12px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; flex: 1; min-width: 120px; transition: 0.3s; }
        .btn-save { background: var(--secondary); }
        .btn-excel { background: var(--success); }
        .btn-archive-toggle { background: var(--archive); }
        #reader { width: 100%; max-width: 400px; margin: 10px auto; display: none; border: 3px solid var(--secondary); border-radius: 12px; }
        .search-box { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 30px; text-align: center; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: var(--primary); color: white; }
        .asset-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; color: white; }
        .mode-indicator { text-align: center; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body> 

<div class="container">
    <h2>ğŸ¥ Ù†Ø¸Ø§Ù… Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø°ÙƒÙŠ</h2> 

    <div id="ui-mode" class="mode-indicator" style="background: #e1f5fe; color: #0288d1;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©</div>

    <div class="no-print">
        <input type="hidden" id="edit-id">
        <div id="reader"></div> 
        <div class="form-grid">
            <div class="form-group"><label>Ø§Ù„ØµÙ†Ù</label><input type="text" id="assetName"></div>
            <div class="form-group"><label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label><input type="text" id="assetBarcode" onfocus="startScanner()"></div>
            <div class="form-group"><label>Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="assetDept"></div>
            <div class="form-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="assetQty" value="1"></div>
            <div class="form-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="assetStatus">
                    <option>Ø¬Ø¯ÙŠØ¯</option><option>Ù…Ø³ØªØ¹Ù…Ù„</option><option>ØµÙŠØ§Ù†Ø©</option><option>ØªØ§Ù„Ù</option>
                </select>
            </div>
            <div class="form-group"><label>Ø§Ù„ØµÙˆØ±Ø©</label><input type="file" id="assetImage" accept="image/*"></div>
        </div> 

        <div class="btn-group">
            <button onclick="handleSave()" class="btn-save" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="exportToExcel()" class="btn-excel">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
            <button onclick="toggleArchiveMode()" class="btn-archive-toggle" id="archiveToggleBtn">ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
        </div> 

        <input type="text" id="searchInput" onkeyup="searchTable()" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…...">
    </div> 

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr><th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div> 

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyDqF69vfiboCuIyJmT73ftwu0zUOeqGAqQ",
        authDomain: "hospital-app-69f54.firebaseapp.com",
        projectId: "hospital-app-69f54",
        databaseURL: "https://hospital-app-69f54-default-rtdb.firebaseio.com",
        storageBucket: "hospital-app-69f54.firebasestorage.app",
        messagingSenderId: "304416015250",
        appId: "1:304416015250:web:c327a0e6120ed2a19d374b"
    }; 
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); 

    let isArchiveMode = false;

    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
    let html5QrCode;
    async function startScanner() {
        if(document.getElementById('assetBarcode').value !== "") return;
        document.getElementById('reader').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                document.getElementById('assetBarcode').value = text;
                stopScanner();
                document.getElementById('assetDept').focus();
            });
        } catch (e) { document.getElementById('reader').style.display = 'none'; }
    }
    function stopScanner() { if(html5QrCode) html5QrCode.stop().then(()=> document.getElementById('reader').style.display='none'); }

    // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 300; canvas.height = (img.height * 300) / img.width;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    // --- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ© ---
    async function handleSave() {
        const id = document.getElementById('edit-id').value;
        const file = document.getElementById('assetImage').files[0];
        let imageData = "";
        
        if(file) imageData = await compressImage(file);
        else if(id) {
            const snap = await db.ref('assets/' + id).once('value');
            imageData = snap.val().image || "";
        }

        const data = {
            name: document.getElementById('assetName').value,
            barcode: document.getElementById('assetBarcode').value,
            dept: document.getElementById('assetDept').value,
            qty: document.getElementById('assetQty').value,
            status: document.getElementById('assetStatus').value,
            image: imageData,
            archived: false
        };

        if(!data.name || !data.barcode) return alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");

        if(id) await db.ref('assets/' + id).update(data);
        else await db.ref('assets').push(data);
        resetForm();
    }

    function archiveAsset(id) {
        if(confirm("Ù†Ù‚Ù„ Ø§Ù„ØµÙ†Ù Ù„Ù„Ø£Ø±Ø´ÙŠÙØŸ")) db.ref('assets/' + id).update({ archived: true });
    }

    function restoreAsset(id) {
        if(confirm("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙ†Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©ØŸ")) db.ref('assets/' + id).update({ archived: false });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØºÙŠØ± (Ù†Ø´Ø· / Ù…Ø¤Ø±Ø´Ù) ---
    function toggleArchiveMode() {
        isArchiveMode = !isArchiveMode;
        const btn = document.getElementById('archiveToggleBtn');
        const indicator = document.getElementById('ui-mode');
        
        if(isArchiveMode) {
            btn.innerText = "ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ø´Ø·";
            indicator.innerText = "ğŸ“‚ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª)";
            indicator.style.background = "#f3e5f5"; indicator.style.color = "#7b1fa2";
        } else {
            btn.innerText = "ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ";
            indicator.innerText = "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©";
            indicator.style.background = "#e1f5fe"; indicator.style.color = "#0288d1";
        }
        loadData();
    }

    function loadData() {
        db.ref('assets').on('value', (snapshot) => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            snapshot.forEach((child) => {
                const item = child.val();
                if(item.archived !== isArchiveMode) return;

                tbody.innerHTML += `
                    <tr>
                        <td><img src="${item.image || 'https://via.placeholder.com/50'}" class="asset-img"></td>
                        <td>${item.name}</td><td>${item.barcode}</td><td>${item.dept}</td><td>${item.qty}</td>
                        <td class="action-btns">
                            ${isArchiveMode ? 
                                `<button onclick="restoreAsset('${child.key}')" style="background:var(--success)">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>` : 
                                `<button onclick="editAsset('${child.key}')" style="background:var(--warning);color:black">ğŸ“</button>
                                 <button onclick="archiveAsset('${child.key}')" style="background:var(--danger)">ğŸ—‘ï¸</button>`
                            }
                        </td>
                    </tr>`;
            });
        });
    }

    // --- ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¨Ø­Ø« ---
    async function editAsset(id) {
        const snap = await db.ref('assets/' + id).once('value');
        const item = snap.val();
        document.getElementById('assetName').value = item.name;
        document.getElementById('assetBarcode').value = item.barcode;
        document.getElementById('assetDept').value = item.dept;
        document.getElementById('assetQty').value = item.qty;
        document.getElementById('edit-id').value = id;
        document.getElementById('saveBtn').innerText = "ğŸ”„ ØªØ­Ø¯ÙŠØ«";
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.querySelectorAll('input').forEach(i => i.value="");
        document.getElementById('edit-id').value = "";
        document.getElementById('saveBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    }

    function searchTable() {
        let val = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll("#tableBody tr").forEach(tr => {
            tr.style.display = tr.innerText.toLowerCase().includes(val) ? "" : "none";
        });
    }

    // --- ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ ---
    async function exportToExcel() {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰');
        sheet.columns = [
            {header:'Ø§Ù„ØµÙˆØ±Ø©', key:'img', width:15},
            {header:'Ø§Ù„ØµÙ†Ù', key:'name', width:25},
            {header:'Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', key:'barcode', width:20},
            {header:'Ø§Ù„Ù‚Ø³Ù…', key:'dept', width:20},
            {header:'Ø§Ù„ÙƒÙ…ÙŠØ©', key:'qty', width:10},
            {header:'Ø§Ù„Ø­Ø§Ù„Ø©', key:'status', width:15}
        ];

        const snap = await db.ref('assets').once('value');
        let rIdx = 2;
        
        snap.forEach(child => {
            const item = child.val();
            if(item.archived) return; // ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø·

            const row = sheet.addRow(item);
            row.height = 65;
            row.alignment = {vertical:'middle', horizontal:'center'};

            if(item.image) {
                try {
                    const imgId = workbook.addImage({base64: item.image, extension:'jpeg'});
                    sheet.addImage(imgId, {tl:{col:0, row:rIdx-1}, ext:{width:60, height:60}});
                } catch(e){}
            }
            rIdx++;
        });

        const buf = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buf]), `Inventory_Full_${new Date().toLocaleDateString()}.xlsx`);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    loadData();
</script>
</body>
</html>